<!-- flatbar.html/index.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>평철 + 파이프살 | 고래이음 난간 시뮬레이터</title>

    <link rel="stylesheet" href="../../shared/css/app.css" />

    <style>
        :root {
            --leftW: 320px;
            --rightW: 360px;
            --topbarH: 56px;
            --edgeGap: 0px;
            --edgeOverlap: 0px;
        }

        body {
            margin: 0;
            display: flex;
            font-family: 'Pretendard', sans-serif;
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }

        /* ===== Left sidebar ===== */
        #sidebar {
            width: var(--leftW);
            padding: 18px 18px 22px;
            background: #fff;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0, 0, 0, .05);
            z-index: 100;
            box-sizing: border-box;
            flex: 0 0 var(--leftW);
            /* ✅ 추가 */
            flex-shrink: 0;
            /* ✅ 추가 */
        }

        /* ===== Canvas ===== */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background: #eee;
            flex: 1 1 auto;
            /* ✅ 추가 */
            min-width: 0;
            /* ✅ 추가(중요: overflow/축소 문제 방지) */
            padding-top: var(--topbarH);
        }

        /* ===== Right quote panel ===== */
        #quote-panel {
            width: var(--rightW);
            padding: 18px 18px 22px;
            background: #fff;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -2px 0 15px rgba(0, 0, 0, .05);
            z-index: 100;
            border-left: 1px solid #eef1f4;
            box-sizing: border-box;
            flex: 0 0 var(--rightW);
            /* ✅ 추가 */
            flex-shrink: 0;
            /* ✅ 추가 */
        }

        /* ===== Topbar ===== */
        header.topbar {
            position: fixed;
            left: var(--leftW);
            right: var(--rightW);
            top: 0;
            height: var(--topbarH);
            z-index: 250;
        }

        /* ===== inputs ===== */
        .input-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 700;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input[type="number"]:focus {
            border-color: #007bff;
            outline: none;
        }

        .pageTitle {
            font-size: 16px;
            font-weight: 900;
            margin: 8px 0 4px;
        }

        .pageSub {
            font-size: 12px;
            color: #777;
            margin: 0 0 14px;
            line-height: 1.5;
        }

        .row2 {
            display: flex;
            gap: 8px;
        }

        .row2 input {
            width: 50%;
        }

        .info-box {
            font-size: 11px;
            color: #888;
            line-height: 1.6;
            background: #f1f3f5;
            padding: 10px;
            border-radius: 10px;
            margin-top: 14px;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, .82);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            visibility: hidden;
            font-weight: 900;
        }

        .badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 999px;
            background: #f1f3f5;
            color: #495057;
            margin-top: 8px;
        }

        /* ===== Sidebar Sections (Accordion) ===== */
        .acc {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #fff;
            overflow: hidden;
            margin: 10px 0;
        }

        .acc>summary {
            list-style: none;
            cursor: pointer;
            user-select: none;
            padding: 12px 12px;
            font-size: 13px;
            font-weight: 900;
            color: #343a40;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border-bottom: 1px solid #eef1f4;
        }

        .acc>summary::-webkit-details-marker {
            display: none;
        }

        .acc>summary .chev {
            font-weight: 900;
            color: #868e96;
            transform: rotate(0deg);
            transition: transform .15s ease;
        }

        .acc[open]>summary .chev {
            transform: rotate(90deg);
        }

        .acc-body {
            padding: 12px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-mini {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #f3f5f7;
            color: #222;
            font-weight: 900;
            cursor: pointer;
            user-select: none;
            flex: 1 1 0;
            /* ✅ 버튼 폭 균등 */
            min-width: 88px;
        }

        .btn-mini.on {
            background: #e7f1ff;
            border-color: #a8ccff;
            color: #0b57d0;
        }

        .step-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: #f1f3f5;
            margin-top: 10px;
            font-size: 12px;
            color: #495057;
            font-weight: 900;
        }

        .step-pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid #e9ecef;
            color: #0b57d0;
            font-weight: 900;
            font-size: 12px;
            min-width: 56px;
            text-align: center;
        }

        .tiny-help {
            font-size: 11px;
            color: #888;
            line-height: 1.5;
            margin-top: 10px;
            word-break: break-word;
        }

        /* ===== Quote panel header ===== */
        .quote-head {
            margin-bottom: 12px;
        }

        .quote-title {
            font-size: 16px;
            font-weight: 900;
            margin: 8px 0 2px;
        }

        .quote-sub {
            font-size: 12px;
            color: #777;
            margin: 0 0 10px;
            line-height: 1.4;
        }

        /* ===== Edge toggle buttons ===== */
        .edge-toggle {
            position: fixed;
            top: calc(var(--topbarH) + 12px);
            z-index: 400;

            width: 30px;
            height: 64px;

            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: rgba(255, 255, 255, .95);

            font-weight: 900;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;

            display: grid;
            place-items: center;

            box-shadow: 0 8px 18px rgba(0, 0, 0, .08);
            user-select: none;
        }

        .edge-toggle.left {
            left: calc(var(--leftW) - var(--edgeOverlap) + var(--edgeGap));
            transform: translateX(-100%);
        }

        .edge-toggle.right {
            right: calc(var(--rightW) - var(--edgeOverlap) + var(--edgeGap));
            transform: translateX(100%);
        }

        body.left-collapsed .edge-toggle.left {
            left: 0;
            transform: translateX(0);
            flex-basis: 0 !important;
            /* ✅ 추가 */
        }

        body.right-collapsed .edge-toggle.right {
            right: 0;
            transform: translateX(0);
            flex-basis: 0 !important;
            /* ✅ 추가 */
        }

        /* ===== Collapsed states ===== */
        body.left-collapsed {
            --leftW: 0px;
        }

        body.right-collapsed {
            --rightW: 0px;
        }

        body.left-collapsed #sidebar {
            width: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            overflow: hidden !important;
            box-shadow: none !important;
        }

        body.right-collapsed #quote-panel {
            width: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            overflow: hidden !important;
            box-shadow: none !important;
        }

        body.left-collapsed header.topbar {
            left: 0 !important;
        }

        body.right-collapsed header.topbar {
            right: 0 !important;
        }

        body.left-collapsed.right-collapsed header.topbar {
            left: 0 !important;
            right: 0 !important;
        }

        #sidebar,
        #quote-panel,
        header.topbar {
            transition: width .18s ease, left .18s ease, right .18s ease, padding .18s ease;
        }

        .edge-toggle:hover {
            background: #fff;
        }

        /* ✅ 링크(a)도 btn-mini 버튼처럼 */
        a.btn-mini {
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        /* ✅ 견적 패널 구분선 */
        .quote-divider {
            border: 0;
            border-top: 1px solid #e9ecef;
            margin: 14px 0 12px;
        }
    </style>
</head>

<body>
    <!-- topbar -->
    <header class="topbar">
        <a class="brand" href="#" id="brandLink">고래이음</a>
        <nav class="nav">
            <a href="#" id="homeLink">Home</a>
            <a class="active" href="../">Back</a>
        </nav>
    </header>

    <!-- LEFT -->
    <aside id="sidebar">
        <div class="badge">Railing / Flatbar + Pipe</div>
        <div class="pageTitle">평철 + 파이프살</div>
        <p class="pageSub">
            위/아래 평철 + 파이프 살 + (옵션) 포스트/받침 구성.<br>
            값 변경 시 3D 모델이 실시간 업데이트됩니다.
        </p>

        <!-- 1) 보기/공정(항상 펼침) -->
        <details class="acc" open>
            <summary>
                <span>1. 보기 및 공정 시뮬</span>
                <span class="chev">›</span>
            </summary>

            <div class="acc-body">
                <div class="input-group" style="margin-top:0;">
                    <label>색상 / 사람</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="color" id="allColor" value="#666666" style="flex:1; height:42px;" />
                        <button id="btnHuman" class="btn-mini on" type="button" style="flex:0; min-width:110px;">사람
                            ON</button>
                    </div>
                </div>

                <div class="step-box" style="margin-top:10px;">
                    <span>단계</span>
                    <span class="step-pill" id="buildStepLabel">0 / 4</span>
                </div>

                <div class="btn-row" style="margin-top:10px;">
                    <button id="btnStepPrev" class="btn-mini" type="button">Prev</button>
                    <button id="btnStepNext" class="btn-mini" type="button">Next</button>
                    <button id="btnStepReset" class="btn-mini" type="button">Reset</button>
                </div>

                <div class="btn-row" style="margin-top:12px;">
                    <button id="btnPosts" class="btn-mini on" type="button">포스트 ON</button>
                    <button id="btnRailBot" class="btn-mini on" type="button">하부레일 ON</button>
                    <button id="btnSlats" class="btn-mini on" type="button">중간살 ON</button>
                    <button id="btnRailTop" class="btn-mini on" type="button">상부레일 ON</button>
                </div>

                <div class="tiny-help">
                    * 단계(0~4): 0=없음 → 1=포스트 → 2=하부레일 → 3=중간살 → 4=상부레일<br>
                    * 토글을 수동으로 누르면 단계는 0으로 초기화됩니다.
                </div>
            </div>
        </details>

        <!-- 2) 전체 설정 -->
        <details class="acc" open>
            <summary>
                <span>2. 전체 설정</span>
                <span class="chev">›</span>
            </summary>
            <div class="acc-body">
                <div class="input-group">
                    <label>전체 길이 (mm)</label>
                    <input type="number" id="totalL" value="3000">
                </div>
                <div class="input-group">
                    <label>난간 높이 (mm) <span style="font-weight:400;">(상부레일 상단 기준)</span></label>
                    <input type="number" id="height" value="1200">
                </div>
            </div>
        </details>

        <!-- 3) 세부 설정 -->
        <details class="acc" open>
            <summary>
                <span>3. 세부 설정</span>
                <span class="chev">›</span>
            </summary>
            <div class="acc-body">
                <div class="input-group">
                    <label>포스트(기둥) 간격 (mm)</label>
                    <input type="number" id="postInt" value="1000">
                </div>

                <div class="input-group">
                    <label>살(파이프) 간격 (mm)</label>
                    <input type="number" id="picketGap" value="100">
                </div>

                <div class="input-group">
                    <label>파이프(살) 외경 (mm)</label>
                    <input type="number" id="pipeOD" value="20" step="0.1">
                </div>

                <div class="input-group">
                    <label>평철 폭 / 두께 (mm)</label>
                    <div class="row2">
                        <input type="number" id="barW" value="50" title="평철 폭">
                        <input type="number" id="barT" value="6" title="평철 두께">
                    </div>
                </div>
            </div>
        </details>

        <!-- 4) (자리만) -->
        <details class="acc">
            <summary>
                <span>4. 옵션(추후)</span>
                <span class="chev">›</span>
            </summary>
            <div class="acc-body">
                <div class="tiny-help">* 추후: 체결 방식(팝너트/용접), 마감(도장/분체), 손스침 등 추가</div>
            </div>
        </details>

        <!-- 5) 안내 -->
        <details class="acc">
            <summary>
                <span>5. 안내</span>
                <span class="chev">›</span>
            </summary>
            <div class="acc-body">
                <div class="info-box" style="margin-top:0;">
                    * Home / Railings 이동은 상단 메뉴에서 가능합니다.<br>
                    * 공정 시뮬 단계는 “보이기” 전용(견적은 실제 토글/입력값 기준).<br>
                    * 견적/DB 연결은 우측 패널에서 실행됩니다.
                </div>
            </div>
        </details>
    </aside>

    <!-- CENTER -->
    <main id="canvas-container">
        <div id="loading" class="loading-overlay">모델 데이터를 불러오는 중...</div>
    </main>

    <!-- RIGHT: quote -->
    <aside id="quote-panel" aria-label="견적 패널">
        <div class="quote-head">
            <div class="quote-title">견적</div>
            <div class="quote-sub">설정값 변경 시 자동으로 재산출됩니다.</div>
        </div>

        <div class="acc-body" style="padding:0;">
            <div class="btn-row">
                <button id="btnQuote" class="btn-mini on" type="button">견적 계산</button>
                <button id="btnQuotePdf" class="btn-mini" type="button" style="display:none;">견적서 PDF</button>
            </div>

            <div class="step-box" style="margin-top:10px;">
                <span>총액(VAT포함)</span>
                <span class="step-pill" id="quoteTotal">-</span>
            </div>

            <div class="tiny-help" id="quoteBreakdown" style="margin-top:10px;"></div>
            <div class="tiny-help" id="quoteBOM" style="margin-top:10px;"></div>

            <hr class="quote-divider" />

            <div class="btn-row" style="margin-top:0;">
                <a id="btnShopLink" class="btn-mini"
                    href="https://goraeeum.cafe24.com/product/%EB%9D%BC%EC%9A%B4%EB%93%9C-%EC%8A%A4%ED%83%A0%EB%8B%A4%EB%93%9C-%ED%95%B8%EB%93%9C%EB%A0%88%EC%9D%BC-hr-rs-001/49/category/59/display/1/"
                    target="_blank" rel="noopener">
                    구매 쇼핑몰 이동
                </a>
            </div>

        </div>
    </aside>

    <!-- Panel edge toggle buttons -->
    <button id="btnToggleLeft" class="edge-toggle left" type="button" aria-label="왼쪽 패널 토글">❮</button>
    <button id="btnToggleRight" class="edge-toggle right" type="button" aria-label="오른쪽 패널 토글">❯</button>

    <!-- three core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- page app -->
    <script src="./js/app.js"></script>

    <!-- PDF libs -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- ✅ Node 없이도 폰트 로딩(같은 서버 경로에 ttf가 있어야 함) -->
    <script>
        (async () => {
            // 이미 base64가 있으면(기존 base64.js 방식) 그대로 사용
            if (window.__GE_PDF_FONT_B64__) return;
            try {
                const res = await fetch("../../shared/quote/fonts/Pretendard-Regular.ttf");
                if (!res.ok) return;
                const buf = await res.arrayBuffer();
                const bytes = new Uint8Array(buf);

                // btoa는 큰 배열에 취약하니 chunk 변환
                let binary = "";
                const chunk = 0x4000;
                for (let i = 0; i < bytes.length; i += chunk) {
                    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
                }
                window.__GE_PDF_FONT_B64__ = btoa(binary);
            } catch (e) {
                console.warn("Pretendard font load failed:", e);
            }
        })();
    </script>

    <!-- shared quote modules -->
    <script src="../../shared/quote/quote-core.js"></script>
    <script src="../../shared/quote/quote-ui.js"></script>

    <!-- model quote logic -->
    <script src="./js/quote-model.js"></script>

    <!-- panel toggle logic -->
    <script>
        (() => {
            const btnL = document.getElementById('btnToggleLeft');
            const btnR = document.getElementById('btnToggleRight');

            function syncIcons() {
                const leftCollapsed = document.body.classList.contains('left-collapsed');
                const rightCollapsed = document.body.classList.contains('right-collapsed');
                btnL.textContent = leftCollapsed ? '❯' : '❮';
                btnR.textContent = rightCollapsed ? '❮' : '❯';
            }

            btnL.addEventListener('click', () => {
                document.body.classList.toggle('left-collapsed');
                syncIcons();
                window.dispatchEvent(new Event('resize'));
            });

            btnR.addEventListener('click', () => {
                document.body.classList.toggle('right-collapsed');
                syncIcons();
                window.dispatchEvent(new Event('resize'));
            });

            syncIcons();
        })();
    </script>
</body>

</html>